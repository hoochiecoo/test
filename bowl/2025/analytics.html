<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Боулинг Прогресс - Анализ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
        .container { padding: 20px; max-width: 900px; margin: 20px auto; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { color: #0056b3; margin-bottom: 20px; }
        .filters { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .filters label, .filters select { margin-right: 15px; }
        .stats-summary { display: flex; justify-content: space-around; flex-wrap: wrap; margin-top: 20px; }
        .stat-card { background-color: #e9f5ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 15px; margin: 10px; flex: 1 1 200px; text-align: center; }
        .stat-card h3 { color: #0056b3; margin-bottom: 5px; }
        .stat-card p { font-size: 1.2em; font-weight: bold; }
        .games-list { margin-top: 30px; }
        .games-list h3 { border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }
        .game-item { background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .game-item span { font-weight: bold; }
    </style>
    <script type="application/json" id="domain-contract">
        {
            "domainName": "domain-analysis",
            "description": "Страница для просмотра детализированной статистики и анализа прогресса учеников.",
            "usesLocalStorageKeys": [
                "bowlingApp_students",
                "bowlingApp_games"
            ],
            "writesToLocalStorageKeys": [],
            "expectsUrlParameters": {},
            "generatesUrlParameters": {},
            "usesExternalServices": [],
            "dependsOnDomainsData": ["domain-profiles"]
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadStudentsToFilter();
            document.getElementById('studentFilter').onchange = displayAnalytics;
            displayAnalytics(); // Загрузка аналитики при загрузке страницы (возможно, для всех)
        });

        function loadStudentsToFilter() {
            const students = JSON.parse(localStorage.getItem('bowlingApp_students') || '[]');
            const studentFilter = document.getElementById('studentFilter');
            studentFilter.innerHTML = '<option value="all">Все ученики</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                studentFilter.appendChild(option);
            });
        }

        function displayAnalytics() {
            const selectedStudentId = document.getElementById('studentFilter').value;
            const students = JSON.parse(localStorage.getItem('bowlingApp_students') || '[]');
            const allGames = JSON.parse(localStorage.getItem('bowlingApp_games') || '[]');

            let filteredGames = [];
            if (selectedStudentId === 'all') {
                filteredGames = allGames;
            } else {
                filteredGames = allGames.filter(game => game.studentId === selectedStudentId);
            }

            // Статистика
            const totalGames = filteredGames.length;
            const totalScore = filteredGames.reduce((sum, game) => sum + game.score, 0);
            const averageScore = totalGames > 0 ? Math.round(totalScore / totalGames) : 0;
            const bestGame = filteredGames.length > 0 ? Math.max(...filteredGames.map(game => game.score)) : 0;

            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('averageScore').textContent = averageScore;
            document.getElementById('bestGame').textContent = bestGame;

            // Список игр
            const gamesListDiv = document.getElementById('games-list-details');
            gamesListDiv.innerHTML = '';
            if (filteredGames.length === 0) {
                gamesListDiv.innerHTML = '<p>Нет данных по играм для выбранного ученика/группы.</p>';
                return;
            }

            filteredGames.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(game => {
                const student = students.find(s => s.id === game.studentId);
                const gameItem = document.createElement('div');
                gameItem.className = 'game-item';
                gameItem.innerHTML = `
                    <span>${game.date} - ${student ? student.name : 'Неизвестный ученик'}</span>
                    <span>Счет: ${game.score}</span>
                `;
                gamesListDiv.appendChild(gameItem);
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <h2>Анализ Прогресса</h2>

        <div class="filters">
            <label for="studentFilter">Фильтр по ученику:</label>
            <select id="studentFilter">
                <!-- Ученики загружаются JS -->
            </select>
        </div>

        <div class="stats-summary">
            <div class="stat-card">
                <h3>Всего игр</h3>
                <p id="totalGames">0</p>
            </div>
            <div class="stat-card">
                <h3>Средний счет</h3>
                <p id="averageScore">0</p>
            </div>
            <div class="stat-card">
                <h3>Лучшая игра</h3>
                <p id="bestGame">0</p>
            </div>
        </div>

        <div class="games-list">
            <h3>Детализированный список игр</h3>
            <div id="games-list-details">
                <!-- Список игр загружается JS -->
            </div>
        </div>
    </div>
</body>
</html>