<!DOCTYPE html>
<html>
<head>
  <title>Mini WebRTC Room Call</title>
</head>
<body>
  <h2>Мини звонок по комнате</h2>
  <video id="local" autoplay muted></video>
  <video id="remote" autoplay></video>
  <input id="signalInput" placeholder="Введите Signal URL (https://...)"/>
  <input id="roomInput" placeholder="Введите комнату"/>
  <button id="joinBtn">Войти в комнату</button>
  <button id="callBtn">Позвонить</button>

<script>
const localVideo = document.getElementById('local');
const remoteVideo = document.getElementById('remote');
const signalInput = document.getElementById('signalInput');
const roomInput = document.getElementById('roomInput');
const joinBtn = document.getElementById('joinBtn');
const callBtn = document.getElementById('callBtn');

let pc;
let localStream;
let SIGNAL_URL = null;
let ROOM = null;

const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

async function initMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;

  pc = new RTCPeerConnection(config);
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  pc.onicecandidate = e => {
    if (e.candidate) {
      fetch(SIGNAL_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ room: ROOM, type: 'candidate', data: e.candidate })
      });
    }
  };

  setInterval(async () => {
    const res = await fetch(`${SIGNAL_URL}?room=${ROOM}`);
    const data = await res.json();

    if (data.offer && !pc.remoteDescription) {
      await pc.setRemoteDescription(data.offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await fetch(SIGNAL_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ room: ROOM, type: 'answer', data: answer })
      });
    }

    if (data.answer && !pc.remoteDescription) {
      await pc.setRemoteDescription(data.answer);
    }

    if (data.candidates) {
      for (const c of data.candidates) {
        try { await pc.addIceCandidate(c); } catch(e) {}
      }
      // кандидаты не стираем
    }
  }, 1000);
}

joinBtn.onclick = async () => {
  SIGNAL_URL = signalInput.value.trim();
  ROOM = roomInput.value.trim();
  if (!SIGNAL_URL) return alert('Введите Signal URL');
  if (!ROOM) return alert('Введите комнату');
  await initMedia();
};

callBtn.onclick = async () => {
  if (!ROOM || !SIGNAL_URL) return alert('Сначала войдите в комнату');
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await fetch(SIGNAL_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ room: ROOM, type: 'offer', data: offer })
  });
};
</script>
</body>
</html>
