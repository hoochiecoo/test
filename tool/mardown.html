<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Markdown Preview + Mermaid</title>
    
    <!-- Стили GitHub (светлая тема) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">
    
    <style>
        body {
            margin: 0;
            display: flex;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: #fff;
            overflow: hidden;
        }

        /* Левая панель (Редактор) */
        #editor-pane {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #d0d7de;
            background-color: #f6f8fa;
        }

        .pane-header {
            padding: 8px 16px;
            background: #24292f;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        textarea {
            flex: 1;
            padding: 20px;
            border: none;
            resize: none;
            outline: none;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            background-color: #f6f8fa;
            color: #1f2328;
        }

        /* Правая панель (Превью) */
        #preview-pane {
            width: 50%;
            height: 100%;
            overflow-y: auto;
            padding: 32px;
            box-sizing: border-box;
            background-color: white;
        }

        /* Стиль для контейнера диаграммы, чтобы она была по центру */
        .mermaid {
            display: flex;
            justify-content: center;
            margin: 16px 0;
            background-color: white;
        }
    </style>
</head>
<body>

    <!-- Ввод -->
    <div id="editor-pane">
        <div class="pane-header">Markdown Editor</div>
        <textarea id="markdown-input"></textarea>
    </div>

    <!-- Вывод -->
    <div id="preview-pane" class="markdown-body"></div>

    <!-- Подключаем библиотеки как модули -->
    <script type="module">
        // Импортируем конкретные версии библиотек
        import { marked } from "https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.esm.js";
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.esm.min.mjs";

        // 1. Инициализация Mermaid
        mermaid.initialize({
            startOnLoad: false, // Мы будем вызывать рендер вручную
            theme: 'default',
            securityLevel: 'loose'
        });

        const input = document.getElementById('markdown-input');
        const preview = document.getElementById('preview-pane');

        // 2. Настраиваем Custom Renderer для Marked
        const renderer = new marked.Renderer();
        
        // Сохраняем оригинальный метод для обычного кода
        const originalCodeRenderer = renderer.code.bind(renderer);

        renderer.code = (code, language) => {
            // Если блок кода помечен как mermaid
            if (language === 'mermaid') {
                return `<div class="mermaid">${code}</div>`;
            }
            // Для всех остальных языков используем стандартный рендер
            return originalCodeRenderer(code, language);
        };

        // Применяем рендерер
        marked.use({ renderer });

        // 3. Основная функция рендера
        const renderContent = async () => {
            const text = input.value;
            
            try {
                // ВАЖНО: используем await, так как marked.parse может возвращать Promise
                const html = await marked.parse(text); 
                preview.innerHTML = html;

                // После вставки HTML ищем блоки .mermaid и рендерим их
                await mermaid.run({
                    querySelector: '.mermaid'
                });

            } catch (error) {
                console.error("Ошибка рендера:", error);
            }
        };

        // 4. Debounce (задержка ввода, чтобы не мигало)
        let timeoutId;
        input.addEventListener('input', () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(renderContent, 300);
        });

        // 5. Дефолтный контент при загрузке
        const defaultText = 
`# Markdown + Mermaid Preview

Пример работы диаграмм как на GitHub.

## 1. Блок-схема (Flowchart)
\`\`\`mermaid
graph TD;
    A[Start] --> B{Ошибка исчезла?};
    B -- Да --> C[Отлично!];
    B -- Нет --> D[Проверить консоль];
    C --> E[Готово];
    D --> E;
\`\`\`

## 2. Диаграмма последовательности
\`\`\`mermaid
sequenceDiagram
    participant Alice
    participant Bob
    Alice->>Bob: Привет!
    Bob-->>Alice: Привет, диаграммы работают!
\`\`\`

## 3. Обычный код JS
\`\`\`javascript
const test = "Это не превратится в диаграмму";
console.log(test);
\`\`\`
`;

        input.value = defaultText;
        
        // Первый запуск
        renderContent();
    </script>
</body>
</html>
